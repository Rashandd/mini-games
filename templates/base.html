<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{% block title %}Mini Games{% endblock %}</title>
    <link rel="stylesheet" href="/css/modern.css"/>
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Page Content -->
    <div class="page-content {% block body_class %}{% endblock %}">
        {% block content %}{% endblock %}
    </div>

    <!-- Chat Sidebar Toggle Button -->
    <button class="chat-toggle-btn" id="chatToggle" title="Toggle Chat">
        ğŸ’¬
        <span class="chat-unread-badge" id="chatUnreadBadge" style="display:none;">0</span>
    </button>

    <!-- Chat Sidebar -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
            <div class="chat-sidebar-title">
                <span>ğŸ’¬</span> Chat
            </div>
            <button class="chat-sidebar-close" id="chatClose" title="Close">âœ•</button>
        </div>

        <!-- Chat Tabs -->
        <div class="chat-tabs">
            <button class="chat-tab active" data-tab="dms">DMs</button>
            <button class="chat-tab" data-tab="groups">Groups</button>
            <button class="chat-tab" data-tab="game">Game</button>
        </div>

        <!-- Room List -->
        <div class="chat-room-list" id="chatRoomList">
            <div class="chat-room-list-header">
                <button class="chat-new-btn" id="chatNewDm" title="New DM">+ New DM</button>
                <button class="chat-new-btn" id="chatNewGroup" title="New Group">+ New Group</button>
            </div>
            <div class="chat-rooms" id="chatRooms">
                <div class="chat-empty">No conversations yet</div>
            </div>
        </div>

        <!-- User Search (for new DM) -->
        <div class="chat-user-search" id="chatUserSearch" style="display:none;">
            <div class="chat-search-header">
                <button class="chat-back-btn" id="chatSearchBack">â†</button>
                <span>Find a user</span>
            </div>
            <input type="text" class="chat-search-input" id="chatSearchInput" placeholder="Search by username..." autocomplete="off"/>
            <div class="chat-search-results" id="chatSearchResults"></div>
        </div>

        <!-- New Group Form -->
        <div class="chat-new-group" id="chatNewGroupForm" style="display:none;">
            <div class="chat-search-header">
                <button class="chat-back-btn" id="chatGroupBack">â†</button>
                <span>Create Group</span>
            </div>
            <input type="text" class="chat-search-input" id="chatGroupName" placeholder="Group name..." autocomplete="off"/>
            <button class="btn btn-primary btn-sm" id="chatGroupCreate" style="margin:8px;">Create</button>
        </div>

        <!-- Active Chat View -->
        <div class="chat-active" id="chatActive" style="display:none;">
            <div class="chat-active-header">
                <button class="chat-back-btn" id="chatActiveBack">â†</button>
                <span class="chat-active-name" id="chatActiveName"></span>
                <div class="chat-active-actions">
                    <button class="chat-action-btn" id="chatLeaveBtn" title="Leave">ğŸšª</button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-msg-input" id="chatMsgInput" placeholder="Type a message..." autocomplete="off"/>
                <button class="chat-send-btn" id="chatSendBtn">â¤</button>
            </div>
        </div>
    </div>

    <!-- Context Menu (for moderation) -->
    <div class="chat-context-menu" id="chatContextMenu" style="display:none;">
        <button class="ctx-item" data-action="mute">ğŸ”‡ Mute User</button>
        <button class="ctx-item" data-action="report">ğŸš© Report User</button>
    </div>

    <!-- Socket.IO + Chat JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <script>
    (function() {
        const currentUserId = {{ current_user.id }};
        const currentUsername = "{{ current_user.username }}";
        const socket = io({ transports: ['websocket', 'polling'] });

        // --- State ---
        let sidebarOpen = false;
        let activeTab = 'dms';
        let activeRoomId = null;
        let rooms = [];
        let unreadCount = 0;
        let mutedUsers = new Set();

        // --- DOM refs ---
        const sidebar = document.getElementById('chatSidebar');
        const toggleBtn = document.getElementById('chatToggle');
        const closeBtn = document.getElementById('chatClose');
        const badge = document.getElementById('chatUnreadBadge');
        const roomListEl = document.getElementById('chatRooms');
        const roomListView = document.getElementById('chatRoomList');
        const activeView = document.getElementById('chatActive');
        const searchView = document.getElementById('chatUserSearch');
        const groupView = document.getElementById('chatNewGroupForm');
        const messagesEl = document.getElementById('chatMessages');
        const msgInput = document.getElementById('chatMsgInput');
        const sendBtn = document.getElementById('chatSendBtn');
        const activeName = document.getElementById('chatActiveName');
        const tabs = document.querySelectorAll('.chat-tab');
        const searchInput = document.getElementById('chatSearchInput');
        const searchResults = document.getElementById('chatSearchResults');
        const contextMenu = document.getElementById('chatContextMenu');

        // --- Toggle sidebar ---
        toggleBtn.addEventListener('click', () => {
            sidebarOpen = !sidebarOpen;
            sidebar.classList.toggle('open', sidebarOpen);
            if (sidebarOpen) { loadRooms(); unreadCount = 0; updateBadge(); }
        });
        closeBtn.addEventListener('click', () => {
            sidebarOpen = false;
            sidebar.classList.remove('open');
        });

        // --- Tabs ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeTab = tab.dataset.tab;
                renderRooms();
            });
        });

        // --- New DM ---
        document.getElementById('chatNewDm').addEventListener('click', () => {
            roomListView.style.display = 'none';
            searchView.style.display = 'block';
            searchInput.value = '';
            searchResults.innerHTML = '';
            searchInput.focus();
        });
        document.getElementById('chatSearchBack').addEventListener('click', () => {
            searchView.style.display = 'none';
            roomListView.style.display = 'block';
        });
        searchInput.addEventListener('input', debounce(async () => {
            const q = searchInput.value.trim();
            if (q.length < 2) { searchResults.innerHTML = ''; return; }
            try {
                const res = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
                const users = await res.json();
                searchResults.innerHTML = users.map(u =>
                    `<div class="chat-search-user" data-uid="${u.id}" data-name="${u.username}">${u.username}</div>`
                ).join('') || '<div class="chat-empty">No users found</div>';
            } catch(e) { searchResults.innerHTML = '<div class="chat-empty">Error searching</div>'; }
        }, 300));
        searchResults.addEventListener('click', (e) => {
            const el = e.target.closest('.chat-search-user');
            if (!el) return;
            socket.emit('create_dm', { target_user_id: parseInt(el.dataset.uid) });
            searchView.style.display = 'none';
            roomListView.style.display = 'block';
        });

        // --- New Group ---
        document.getElementById('chatNewGroup').addEventListener('click', () => {
            roomListView.style.display = 'none';
            groupView.style.display = 'block';
            document.getElementById('chatGroupName').value = '';
            document.getElementById('chatGroupName').focus();
        });
        document.getElementById('chatGroupBack').addEventListener('click', () => {
            groupView.style.display = 'none';
            roomListView.style.display = 'block';
        });
        document.getElementById('chatGroupCreate').addEventListener('click', () => {
            const name = document.getElementById('chatGroupName').value.trim();
            if (!name) return;
            socket.emit('create_group', { name: name });
            groupView.style.display = 'none';
            roomListView.style.display = 'block';
        });

        // --- Load rooms ---
        function loadRooms() {
            socket.emit('list_rooms');
        }
        socket.on('room_list', (data) => {
            rooms = data.rooms || [];
            renderRooms();
        });

        function renderRooms() {
            const filtered = rooms.filter(r => {
                if (activeTab === 'dms') return r.type === 'dm';
                if (activeTab === 'groups') return r.type === 'group';
                if (activeTab === 'game') return r.type === 'lobby';
                return true;
            });
            if (filtered.length === 0) {
                roomListEl.innerHTML = '<div class="chat-empty">No conversations</div>';
                return;
            }
            roomListEl.innerHTML = filtered.map(r =>
                `<div class="chat-room-item" data-room-id="${r.id}">
                    <span class="chat-room-icon">${r.type === 'dm' ? 'ğŸ‘¤' : r.type === 'lobby' ? 'ğŸ®' : 'ğŸ‘¥'}</span>
                    <span class="chat-room-name">${escapeHtml(r.name)}</span>
                </div>`
            ).join('');
        }

        // --- Open a room ---
        roomListEl.addEventListener('click', (e) => {
            const el = e.target.closest('.chat-room-item');
            if (!el) return;
            openRoom(parseInt(el.dataset.roomId));
        });

        function openRoom(roomId) {
            activeRoomId = roomId;
            const room = rooms.find(r => r.id === roomId);
            activeName.textContent = room ? room.name : 'Chat';
            messagesEl.innerHTML = '<div class="chat-empty">Loading...</div>';
            roomListView.style.display = 'none';
            activeView.style.display = 'flex';
            socket.emit('join_chat', { room_id: roomId });
            socket.emit('load_messages', { room_id: roomId });
        }

        // --- Back to room list ---
        document.getElementById('chatActiveBack').addEventListener('click', () => {
            if (activeRoomId) socket.emit('leave_chat', { room_id: activeRoomId });
            activeRoomId = null;
            activeView.style.display = 'none';
            roomListView.style.display = 'block';
        });

        // --- Messages ---
        socket.on('message_history', (data) => {
            if (data.room_id !== activeRoomId) return;
            const msgs = data.messages || [];
            if (msgs.length === 0) {
                messagesEl.innerHTML = '<div class="chat-empty">No messages yet. Say hi! ğŸ‘‹</div>';
                return;
            }
            messagesEl.innerHTML = msgs.map(m => renderMessage(m)).join('');
            messagesEl.scrollTop = messagesEl.scrollHeight;
        });

        socket.on('new_message', (data) => {
            if (mutedUsers.has(data.user_id)) return;
            if (data.room_id === activeRoomId) {
                const div = document.createElement('div');
                div.innerHTML = renderMessage(data);
                messagesEl.appendChild(div.firstChild);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } else {
                unreadCount++;
                updateBadge();
            }
        });

        function renderMessage(m) {
            const isMe = m.user_id === currentUserId;
            const time = m.created_at ? new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            return `<div class="chat-msg ${isMe ? 'me' : ''}" data-uid="${m.user_id}" data-mid="${m.id}">
                <span class="chat-msg-author">${escapeHtml(m.username)}</span>
                <span class="chat-msg-text">${escapeHtml(m.content)}</span>
                <span class="chat-msg-time">${time}</span>
            </div>`;
        }

        // --- Send message ---
        function sendMessage() {
            const txt = msgInput.value.trim();
            if (!txt || !activeRoomId) return;
            socket.emit('send_message', { room_id: activeRoomId, content: txt });
            msgInput.value = '';
        }
        sendBtn.addEventListener('click', sendMessage);
        msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

        // --- Leave room ---
        document.getElementById('chatLeaveBtn').addEventListener('click', () => {
            if (!activeRoomId) return;
            socket.emit('chat_leave', { room_id: activeRoomId });
            activeRoomId = null;
            activeView.style.display = 'none';
            roomListView.style.display = 'block';
            loadRooms();
        });

        // --- Context menu (right-click on message) ---
        messagesEl.addEventListener('contextmenu', (e) => {
            const msg = e.target.closest('.chat-msg');
            if (!msg || parseInt(msg.dataset.uid) === currentUserId) return;
            e.preventDefault();
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.dataset.targetUid = msg.dataset.uid;
            contextMenu.dataset.targetMid = msg.dataset.mid;
        });
        document.addEventListener('click', () => { contextMenu.style.display = 'none'; });
        contextMenu.addEventListener('click', (e) => {
            const btn = e.target.closest('.ctx-item');
            if (!btn) return;
            const action = btn.dataset.action;
            const uid = parseInt(contextMenu.dataset.targetUid);
            if (action === 'mute') {
                socket.emit('chat_mute', { muted_user_id: uid, room_id: activeRoomId });
                mutedUsers.add(uid);
            } else if (action === 'report') {
                const reason = prompt('Reason for report (optional):') || '';
                socket.emit('chat_report', { reported_user_id: uid, room_id: activeRoomId, reason: reason });
            }
            contextMenu.style.display = 'none';
        });

        // --- Socket confirmations ---
        socket.on('dm_created', (data) => { loadRooms(); openRoom(data.room_id); });
        socket.on('group_created', (data) => { loadRooms(); openRoom(data.room_id); });
        socket.on('mute_confirmed', () => {});
        socket.on('report_confirmed', () => {});
        socket.on('left_room', () => {});

        // --- Badge ---
        function updateBadge() {
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // --- Helpers ---
        function escapeHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }
        function debounce(fn, ms) {
            let t;
            return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
        }
    })();
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
