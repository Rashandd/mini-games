<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{{ game.name }} ‚Äî Game Room</title>
    <link rel="stylesheet" href="/css/modern.css"/>
    <style>
        .game-layout { display: flex; gap: 16px; max-width: 1100px; width: 100%; margin-top: 16px; }
        .board-panel { flex: 1; min-width: 0; }
        .chat-panel {
            width: 280px; flex-shrink: 0;
            background: var(--bg-card); border: 1px solid var(--border-glass);
            border-radius: var(--radius-lg); display: flex; flex-direction: column;
            max-height: 620px;
        }
        .chat-header { padding: 12px 16px; border-bottom: 1px solid var(--border-glass); font-weight: 600; font-size: 0.85rem; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; font-size: 0.8rem; }
        .chat-messages .msg { margin-bottom: 8px; }
        .chat-messages .msg-user { color: var(--accent-primary); font-weight: 600; }
        .chat-messages .msg-text { color: var(--text-primary); }
        .chat-messages .msg-time { color: var(--text-muted); font-size: 0.7rem; }
        .chat-input-row { display: flex; padding: 8px; border-top: 1px solid var(--border-glass); gap: 6px; }
        .chat-input-row input { flex: 1; }

        .board-container {
            background: var(--bg-card); border: 1px solid var(--border-glass);
            border-radius: var(--radius-lg); padding: 20px; min-height: 500px;
        }
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: var(--bg-glass); border: 1px solid var(--border-glass);
            border-radius: var(--radius-md); margin-bottom: 16px; font-size: 0.85rem;
        }
        .status-bar .turn-indicator { font-weight: 700; color: var(--accent-gold); }
        .players-bar { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .player-tag {
            padding: 6px 12px; border-radius: var(--radius-sm); font-size: 0.8rem; font-weight: 600;
            background: var(--bg-glass); border: 1px solid var(--border-glass);
        }
        .player-tag.active { border-color: var(--accent-primary); box-shadow: 0 0 10px rgba(108,99,255,0.3); }
        .player-tag.you { color: var(--accent-gold); }

        /* Tic-Tac-Toe Board */
        .ttt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 360px; margin: 0 auto; }
        .ttt-cell {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: 800; cursor: pointer; border-radius: var(--radius-md);
            background: var(--bg-glass); border: 1px solid var(--border-glass);
            transition: var(--transition-fast);
        }
        .ttt-cell:hover { background: rgba(108,99,255,0.1); border-color: var(--accent-primary); }
        .ttt-cell.x { color: var(--accent-primary); }
        .ttt-cell.o { color: var(--accent-secondary); }

        /* Chess Board */
        .chess-grid { display: grid; grid-template-columns: repeat(8, 1fr); max-width: 480px; margin: 0 auto; border: 2px solid var(--border-glass); border-radius: 4px; overflow: hidden; }
        .chess-cell {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; cursor: pointer; transition: var(--transition-fast); position: relative;
        }
        .chess-cell.light { background: #e8d5b5; }
        .chess-cell.dark { background: #b58863; }
        .chess-cell.selected { box-shadow: inset 0 0 0 3px var(--accent-primary); }
        .chess-cell.valid-move::after {
            content: ''; position: absolute; width: 30%; height: 30%; border-radius: 50%;
            background: rgba(108,99,255,0.4);
        }

        /* Checkers Board */
        .checkers-grid { display: grid; grid-template-columns: repeat(8, 1fr); max-width: 480px; margin: 0 auto; border: 2px solid var(--border-glass); border-radius: 4px; overflow: hidden; }
        .checkers-cell {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 1.6rem; cursor: pointer; transition: var(--transition-fast);
        }
        .checkers-cell.light { background: #f0d9b5; }
        .checkers-cell.dark { background: #769656; }
        .checkers-cell.selected { box-shadow: inset 0 0 0 3px var(--accent-gold); }

        /* Backgammon */
        .bg-board { max-width: 560px; margin: 0 auto; background: #2d5016; border: 3px solid #8b6914; border-radius: 8px; padding: 12px; }
        .bg-half { display: flex; gap: 4px; justify-content: center; }
        .bg-point { width: 36px; text-align: center; padding: 4px 0; cursor: pointer; min-height: 100px; border-radius: 4px; transition: var(--transition-fast); }
        .bg-point:hover { background: rgba(255,255,255,0.1); }
        .bg-piece { width: 28px; height: 28px; border-radius: 50%; margin: 2px auto; border: 2px solid rgba(255,255,255,0.3); }
        .bg-piece.p1 { background: var(--accent-primary); }
        .bg-piece.p2 { background: var(--accent-secondary); }
        .bg-bar-section { text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; margin: 8px 0; }
        .bg-dice { display: inline-flex; gap: 8px; margin: 8px 0; }
        .bg-die { width: 36px; height: 36px; background: white; color: #333; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.2rem; }

        /* Game Over Overlay */
        .game-over-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: none; align-items: center;
            justify-content: center; z-index: 100;
        }
        .game-over-overlay.show { display: flex; }
        .game-over-card {
            background: var(--bg-card); border: 1px solid var(--border-glass);
            border-radius: var(--radius-xl); padding: 40px; text-align: center;
            animation: cardSlideUp 0.4s ease-out;
        }
        .game-over-card h2 { font-size: 1.5rem; margin-bottom: 8px; }
        .game-over-card .result { font-size: 3rem; margin: 16px 0; }

        @media (max-width: 768px) {
            .game-layout { flex-direction: column; }
            .chat-panel { width: 100%; max-height: 300px; }
        }
    </style>
</head>
<body>
    <div class="page-container" style="padding-top: 16px;">
        <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 999;"></div>

        <!-- Header -->
        <div class="home-header">
            <h1>{{ game.icon }} {{ game.name }}</h1>
            <div class="home-nav">
                <a href="/home" class="btn btn-secondary btn-sm">‚Üê Games</a>
                <a href="/leaderboard/{{ game.slug }}" class="btn btn-secondary btn-sm">üèÜ Rankings</a>
                <button class="btn btn-secondary btn-sm" onclick="resignGame(ROOM_CODE)" id="resign-btn" style="display:none;">üè≥ Resign</button>
            </div>
        </div>

        {% if room_code %}
        <!-- IN A GAME -->
        <div class="status-bar">
            <div class="players-bar">
                <span class="player-tag" id="p1-tag">‚è≥ Waiting for Player 1...</span>
                <span style="color: var(--text-muted); font-weight:600;">VS</span>
                <span class="player-tag" id="p2-tag">‚è≥ Waiting for opponent...</span>
            </div>
            <div class="turn-indicator" id="turn-text">Waiting...</div>
        </div>

        <div class="game-layout">
            <div class="board-panel">
                <div class="board-container" id="board-container">
                    <p style="text-align:center; color: var(--text-muted);">Loading game...</p>
                </div>
            </div>
            <div class="chat-panel">
                <div class="chat-header">üí¨ Game Chat</div>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-row">
                    <input class="form-input" id="chat-input" placeholder="Type a message..." style="font-size:0.8rem;padding:8px;"/>
                    <button class="btn btn-primary btn-sm" onclick="sendChatMsg()">Send</button>
                </div>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div class="game-over-overlay" id="game-over-overlay">
            <div class="game-over-card">
                <h2 id="game-over-title">Game Over</h2>
                <div class="result" id="game-over-result">üèÜ</div>
                <p id="game-over-text" style="color: var(--text-secondary);"></p>
                <div style="display:flex; gap:8px; justify-content:center; margin-top:20px;">
                    <a href="/game/{{ game.slug }}" class="btn btn-primary btn-sm">New Game</a>
                    <a href="/home" class="btn btn-secondary btn-sm">Home</a>
                </div>
            </div>
        </div>

        {% else %}
        <!-- LOBBY -->
        <div class="glass-card" style="max-width: 700px;">
            <h3 style="margin-bottom: 16px;">Game Lobby</h3>

            <!-- Create Game Form -->
            <div style="margin-bottom: 16px;">
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <button class="btn btn-primary btn-sm" onclick="createPublicGame()">üåç Quick Public Game</button>
                    <button class="btn btn-gold btn-sm" onclick="togglePrivateForm()">üîí Create Private Game</button>
                </div>
                <div id="private-form" style="display:none; margin-top:12px; padding:12px; background:var(--bg-glass); border:1px solid var(--border-glass); border-radius:var(--radius-md);">
                    <label class="form-label">Game Password</label>
                    <input type="password" class="form-input" id="private-password" placeholder="Enter password..." style="margin-bottom:8px;"/>
                    <button class="btn btn-primary btn-sm" onclick="createPrivateGame()">üîí Create Private Game</button>
                </div>
            </div>

            <div class="divider">open games</div>

            <!-- Filter Bar -->
            <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
                <input type="text" class="form-input" id="lobby-search" placeholder="Search by host..." style="flex:1; min-width:140px; padding:8px 12px; font-size:0.82rem;" oninput="filterLobbies()"/>
                <select class="form-select" id="lobby-sort" style="width:auto; padding:8px 30px 8px 12px; font-size:0.82rem;" onchange="filterLobbies()">
                    <option value="newest">Newest</option>
                    <option value="oldest">Oldest</option>
                </select>
            </div>

            <!-- Lobby List (dynamic) -->
            <div id="lobby-list">
                <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center;">Loading lobbies...</p>
            </div>
        </div>

        <!-- Password Modal (for joining private games) -->
        <div id="password-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:200; align-items:center; justify-content:center;">
            <div class="glass-card" style="max-width:360px; animation:cardSlideUp 0.3s ease-out;">
                <h3 style="margin-bottom:12px;">üîí Private Game</h3>
                <p style="color:var(--text-secondary); font-size:0.85rem; margin-bottom:12px;">Enter the password to join this game.</p>
                <input type="password" class="form-input" id="join-password" placeholder="Password..." style="margin-bottom:12px;"/>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-primary btn-sm" onclick="submitJoinPassword()">Join</button>
                    <button class="btn btn-secondary btn-sm" onclick="closePasswordModal()">Cancel</button>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="page-footer mt-24"><p>Mini Games Platform</p></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/js/socket_client.js"></script>
    <script>
        const GAME_SLUG = '{{ game.slug }}';
        const ROOM_CODE = '{{ room_code or "" }}';
        const CURRENT_USER = '{{ current_user.username }}';

        // --- Board renderers ---
        const PIECE_MAP = {
            'r': '‚ôú', 'n': '‚ôû', 'b': '‚ôù', 'q': '‚ôõ', 'k': '‚ôö', 'p': '‚ôü',
            'R': '‚ôñ', 'N': '‚ôò', 'B': '‚ôó', 'Q': '‚ôï', 'K': '‚ôî', 'P': '‚ôô',
        };

        function renderTicTacToe(state) {
            const b = state.board;
            const syms = ['', '‚úï', '‚óØ'];
            const cls = ['', 'x', 'o'];
            let html = '<div class="ttt-grid">';
            for (let i = 0; i < 9; i++) {
                html += `<div class="ttt-cell ${cls[b[i]]}" onclick="tttClick(${i})">${syms[b[i]]}</div>`;
            }
            html += '</div>';
            document.getElementById('board-container').innerHTML = html;
        }

        function tttClick(pos) {
            makeMove(ROOM_CODE, { position: pos });
        }

        function renderChess(state) {
            const fen = state.fen;
            const rows = fen.split(' ')[0].split('/');
            let html = '<div class="chess-grid">';
            for (let r = 0; r < 8; r++) {
                let col = 0;
                for (const ch of rows[r]) {
                    if (ch >= '1' && ch <= '8') {
                        for (let i = 0; i < parseInt(ch); i++) {
                            const light = (r + col) % 2 === 0;
                            html += `<div class="chess-cell ${light?'light':'dark'}" data-sq="${String.fromCharCode(97+col)}${8-r}" onclick="chessClick(this)"></div>`;
                            col++;
                        }
                    } else {
                        const light = (r + col) % 2 === 0;
                        html += `<div class="chess-cell ${light?'light':'dark'}" data-sq="${String.fromCharCode(97+col)}${8-r}" onclick="chessClick(this)">${PIECE_MAP[ch]||ch}</div>`;
                        col++;
                    }
                }
            }
            html += '</div>';
            document.getElementById('board-container').innerHTML = html;
        }

        let selectedSquare = null;
        function chessClick(el) {
            const sq = el.dataset.sq;
            if (selectedSquare) {
                makeMove(ROOM_CODE, { uci: selectedSquare + sq });
                selectedSquare = null;
                document.querySelectorAll('.chess-cell.selected').forEach(c => c.classList.remove('selected'));
            } else {
                selectedSquare = sq;
                el.classList.add('selected');
            }
        }

        function renderCheckers(state) {
            const board = state.board;
            const pieces = { 1: 'üî¥', 2: 'üëë', '-1': '‚ö´', '-2': 'üíé' };
            let html = '<div class="checkers-grid">';
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const light = (r + c) % 2 === 0;
                    const p = board[r][c];
                    html += `<div class="checkers-cell ${light?'light':'dark'}" data-r="${r}" data-c="${c}" onclick="checkersClick(${r},${c})">${pieces[p]||''}</div>`;
                }
            }
            html += '</div>';
            document.getElementById('board-container').innerHTML = html;
        }

        let checkersSel = null;
        function checkersClick(r, c) {
            if (checkersSel) {
                makeMove(ROOM_CODE, { from_row: checkersSel[0], from_col: checkersSel[1], to_row: r, to_col: c });
                checkersSel = null;
            } else {
                checkersSel = [r, c];
                const el = document.querySelector(`.checkers-cell[data-r="${r}"][data-c="${c}"]`);
                if (el) el.classList.add('selected');
            }
        }

        function renderBackgammon(state) {
            let html = '<div class="bg-board">';
            // Dice
            if (state.dice && state.dice.length) {
                html += '<div style="text-align:center;"><div class="bg-dice">';
                state.dice.forEach(d => html += `<div class="bg-die">${d}</div>`);
                html += '</div>';
                if (state.remaining_moves && state.remaining_moves.length) {
                    html += `<div style="font-size:0.75rem;color:#ccc;">Remaining: ${state.remaining_moves.join(', ')}</div>`;
                }
                html += '</div>';
            }
            if (state.needs_roll && state.current_player === window.yourPlayer) {
                html += '<div style="text-align:center;margin:8px 0;"><button class="btn btn-primary btn-sm" onclick="makeMove(ROOM_CODE,{action:\'roll\'})">üé≤ Roll Dice</button></div>';
            }
            // Top half (points 13-24)
            html += '<div class="bg-half">';
            for (let pt = 13; pt <= 24; pt++) {
                html += renderBgPoint(state, pt);
            }
            html += '</div>';
            // Bar
            html += `<div class="bg-bar-section">Bar: P1=${state.bar['1']||0} | P2=${state.bar['2']||0} | Borne off: P1=${state.borne_off['1']||0} P2=${state.borne_off['2']||0}</div>`;
            // Bottom half (points 12-1)
            html += '<div class="bg-half">';
            for (let pt = 12; pt >= 1; pt--) {
                html += renderBgPoint(state, pt);
            }
            html += '</div>';
            html += '</div>';
            document.getElementById('board-container').innerHTML = html;
        }

        function renderBgPoint(state, pt) {
            const [player, count] = state.board[pt] || [0, 0];
            let html = `<div class="bg-point" onclick="bgClick(${pt})"><div style="font-size:0.65rem;color:#aaa;">${pt}</div>`;
            for (let i = 0; i < Math.min(count, 5); i++) {
                html += `<div class="bg-piece p${player}"></div>`;
            }
            if (count > 5) html += `<div style="font-size:0.7rem;color:#ccc;">+${count-5}</div>`;
            html += '</div>';
            return html;
        }

        let bgFrom = null;
        function bgClick(pt) {
            if (bgFrom !== null) {
                // Try each remaining die
                const state = window.gameState;
                if (state.remaining_moves && state.remaining_moves.length) {
                    const die = state.remaining_moves[0]; // Try first available
                    makeMove(ROOM_CODE, { from: bgFrom, die: die });
                }
                bgFrom = null;
            } else {
                bgFrom = pt;
            }
        }

        // --- Render dispatcher ---
        const renderers = {
            'tic-tac-toe': renderTicTacToe,
            'chess': renderChess,
            'checkers': renderCheckers,
            'backgammon': renderBackgammon,
        };

        function renderBoard(state) {
            const fn = renderers[GAME_SLUG];
            if (fn) fn(state);
        }

        function updateStatus(state, data) {
            const p1 = data?.player1 || document.getElementById('p1-tag').dataset.name || 'P1';
            const p2 = data?.player2 || document.getElementById('p2-tag').dataset.name || 'P2';
            const p1Tag = document.getElementById('p1-tag');
            const p2Tag = document.getElementById('p2-tag');
            p1Tag.textContent = `üîµ ${p1}`;
            p1Tag.dataset.name = p1;
            p2Tag.textContent = p2 ? `üî¥ ${p2}` : '‚è≥ Waiting...';
            if (p2) p2Tag.dataset.name = p2;

            p1Tag.classList.toggle('active', state.current_player === 1);
            p2Tag.classList.toggle('active', state.current_player === 2);
            p1Tag.classList.toggle('you', window.yourPlayer === 1);
            p2Tag.classList.toggle('you', window.yourPlayer === 2);

            const turnText = document.getElementById('turn-text');
            if (state.current_player === window.yourPlayer) {
                turnText.textContent = 'Your turn!';
                turnText.style.color = 'var(--accent-gold)';
            } else {
                turnText.textContent = "Opponent's turn";
                turnText.style.color = 'var(--text-muted)';
            }

            document.getElementById('resign-btn').style.display = 'inline-flex';
        }

        // --- Event callbacks ---
        function onGameJoined(data) {
            window.yourPlayer = data.your_player;
            renderBoard(data.state);
            updateStatus(data.state, data);
        }

        function onGameUpdate(data) {
            renderBoard(data.state);
            updateStatus(data.state, data);
        }

        function onGameOver(data) {
            const overlay = document.getElementById('game-over-overlay');
            overlay.classList.add('show');
            const title = document.getElementById('game-over-title');
            const result = document.getElementById('game-over-result');
            const text = document.getElementById('game-over-text');

            if (data.resigned) {
                title.textContent = 'Opponent Resigned!';
                result.textContent = 'üè≥Ô∏è';
                text.textContent = `${data.resigned} resigned. ${data.winner_name} wins!`;
            } else if (data.winner === 0) {
                title.textContent = 'Draw!';
                result.textContent = 'ü§ù';
                text.textContent = 'The game ended in a draw.';
            } else if (data.winner === window.yourPlayer) {
                title.textContent = 'You Win!';
                result.textContent = 'üèÜ';
                text.textContent = 'Congratulations!';
            } else {
                title.textContent = 'You Lose';
                result.textContent = 'üòî';
                text.textContent = `${data.winner_name} wins.`;
            }
        }

        // --- Chat ---
        function onChatHistory(data) {
            const el = document.getElementById('chat-messages');
            data.messages.forEach(m => appendChatMsg(m));
            el.scrollTop = el.scrollHeight;
        }

        function onChatMessage(data) {
            appendChatMsg(data);
            const el = document.getElementById('chat-messages');
            el.scrollTop = el.scrollHeight;
        }

        function appendChatMsg(m) {
            const el = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `<span class="msg-user">${m.username}</span> <span class="msg-text">${escapeHtml(m.content)}</span>`;
            el.appendChild(div);
        }

        function sendChatMsg() {
            const input = document.getElementById('chat-input');
            if (input.value.trim()) {
                sendChat(window.chatRoomId, input.value.trim());
                input.value = '';
            }
        }

        document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMsg();
        });

        function escapeHtml(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        // --- Init ---
        if (ROOM_CODE) {
            joinGame(ROOM_CODE);
            // Auto-create chat room for this game
            window.chatRoomId = parseInt('{{ chat_room_id or 0 }}') || null;
            if (window.chatRoomId) joinChat(window.chatRoomId);
        } else {
            // Lobby mode ‚Äî load games list
            loadLobbies();
            setInterval(loadLobbies, 8000); // Auto-refresh every 8s
        }

        // --- Lobby Functions ---
        let allLobbies = [];
        let pendingJoinRoom = null;

        function createPublicGame() {
            findMatch(GAME_SLUG);
        }

        function togglePrivateForm() {
            const f = document.getElementById('private-form');
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        }

        function createPrivateGame() {
            const pw = document.getElementById('private-password').value.trim();
            if (!pw) { alert('Please enter a password.'); return; }
            createGame(GAME_SLUG, true, pw);
        }

        async function loadLobbies() {
            try {
                const res = await fetch(`/api/lobbies/${GAME_SLUG}`);
                allLobbies = await res.json();
                renderLobbies(allLobbies);
            } catch(e) {
                document.getElementById('lobby-list').innerHTML = '<p style="color:var(--text-muted);text-align:center;font-size:0.85rem;">Error loading lobbies.</p>';
            }
        }

        function filterLobbies() {
            const q = document.getElementById('lobby-search').value.toLowerCase().trim();
            const sort = document.getElementById('lobby-sort').value;
            let filtered = allLobbies.filter(g => !q || g.host.toLowerCase().includes(q));
            if (sort === 'oldest') filtered.reverse();
            renderLobbies(filtered);
        }

        function renderLobbies(lobbies) {
            const el = document.getElementById('lobby-list');
            if (!lobbies.length) {
                el.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem;text-align:center;">No open games. Create one above!</p>';
                return;
            }
            el.innerHTML = lobbies.map(g => `
                <div class="village-item" onclick="joinLobbyGame('${g.room_code}', ${g.is_private})">
                    <div class="village-icon">${g.is_private ? 'üîí' : 'üåç'}</div>
                    <div class="village-info">
                        <div class="village-name">${escapeHtml(g.host)}'s game ${g.is_private ? '<span style="color:var(--accent-gold);font-size:0.72rem;">(Private)</span>' : ''}</div>
                        <div class="village-level">Room: ${g.room_code} ¬∑ ${g.age}</div>
                    </div>
                </div>
            `).join('');
        }

        function joinLobbyGame(roomCode, isPrivate) {
            if (isPrivate) {
                pendingJoinRoom = roomCode;
                document.getElementById('password-modal').style.display = 'flex';
                document.getElementById('join-password').value = '';
                document.getElementById('join-password').focus();
            } else {
                window.location = `/game/${GAME_SLUG}/${roomCode}`;
            }
        }

        function submitJoinPassword() {
            const pw = document.getElementById('join-password').value.trim();
            if (!pw) return;
            // Join via socket with password
            joinGameWithPassword(pendingJoinRoom, pw);
            closePasswordModal();
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            pendingJoinRoom = null;
        }
    </script>
</body>
</html>
